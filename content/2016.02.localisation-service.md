Title: The Mozilla Firefox localization dilema
Lang: en
Url: localization-service
Slug: localization-service
Date: 2016-02-10
Summary: How to release Firefox in 90 languages and being able to fix mistakes.

In this article, we present a proof-of-concept where Kinto is used to
manage the translated strings of Firefox.

# Problems we are trying to solve

Under the [Go Faster project umbrella](https://wiki.mozilla.org/Firefox/Go_Faster>).
which aims to ship new feature into Firefox faster, we investigate
use-cases where our Kinto solution can bring value.

It appeared that the Firefox localization process could gain a bit of
flexibility.

Today the release flow for Firefox Desktop is the following:

- A release with the en-US built-in translation is made.
- A string freeze for the release is triggered for the translators
  community to translate the remaining missing strings.
- As soon as a language is completely translated, the translators mark
  it as ready.
- The language translation strings are then review.
- The translation strings are split into files (a file per view)
- DTD Entities XML files for XUL based code and .properties string
  bundles for JSM and C++ based code

This flow put a lot of pressure on the contributors, who must ship
translations of more than 90 languages as soon as Firefox string
freeze is triggered.

This process has to be repeated every 6 weeks for each Developer
Edition, Beta, Release, ESR release channels and for all supported
languages.

To handle all the translation heavy flow, two main tools are used:

- [Pontoon](https://pontoon.mozilla.org/) a UI to localize strings
  in place.
- [Elmo](https://l10n.mozilla.org) the central coordination
  platform.

If an error occurs in the flow, a chemspill release as to be built for
the erroneous language. For typos, we usually have to wait the next
train.


# What are the solutions?

Bundling Firefox like that takes too much time that we do not have. We
are looking for ways to go faster and to paralize tasks.

Ideally, we'd like to be able to localize during development, instead
of waiting for string feeze.

An alternate solution would be to rely on language packs updates via
the addons channel.

Thanks to the Nightly channel we have metrics on the frequency of
displayed strings (from critical ones to rare security errors or
deeply hidden menus).

This can help us to distinguish which translated strings would have to
be embedded in the release from the ones that can be delivered later
on in real time.

This would allow us to consider releasing a partialy localized
Firefox with daily string updates.


# Proof-of-concept using Kinto

We thought it would be relevant to build a proof-of-concept with Kinto
for this problem of releasing translations.

For this use-case, there is no major synchronization issue since there
is only source of truth and we can even sign the collection to make
sure the version we have synced is the one Mozilla shipped.

Plus, since Kinto.js shipped within Firefox for the synchronization of
blocklists and security settings, it shouldn't be costly!

The translations strings would be stored and managed on a Kinto
server, and synchronized locally a bit after browser startup (or
periodically).

We identified [Hello](https://www.mozilla.org/fr/firefox/hello/) as
a candidate component for our proof-of-concept, since we are already
familiar with this well scoped project and because it is implemented
in JavaScript.


## From translations sources to Kinto

Currently properties files are loaded when the view loads.

Instead of loading them from files we plugged the Kinto collection
instead.

This process can be triggered as soon as the new translation strings
are ready from Elmo (ie. the source of truth).

Also, now that Kinto has a web admin, we can play with it and edit the
previously loaded records with a Web UI.


## Edit translations using Kinto-admin

The translation team is fully equiped when it comes to editing
translated strings. But for the purpose of this proof-of-concept, it
is fun to provide a Web UI to show how they can be edited and
synchronized.

Kinto-admin relies on JSON schemas to generate forms automatically.

We defined a very simple one:

```json    
    {
      "name": "Loop-Client translation",
      "config": {
        "displayFields": ["key", "value"],
        "schema": {
          "title": "Loop-Client translation",
          "description": "Loop-Client translation strings",
          "type": "object",
          "additionalProperties": false,
          "required": [
            "key", "value"
          ],
          "properties": {
            "key": {
              "type": "string",
              "title": "Key",
              "description": "The translation key",
              "minLength": 1,
              "default": ""
            },
            "value": {
              "type": "string",
              "title": "Value",
              "description": "The translation",
              "minLength": 1,
              "default": ""
            }
          }
        }
      }
    }
```

Which generates the following simple form:

![The Kinto Admin on the french category]({filename}/images/french-translation.png)

When records are saved and synced on the server, the clients will be able fetch them.


Synchronize and read translated strings with Kinto.js
-----------------------------------------------------

Load kinto.js component:

```javascript
    Cu.import("resource://services-common/moz-kinto-client.js");
    const Kinto = loadKinto();
```

Synchronize from server on startup:


Hack l10n.js to rely on Kinto for reading translated strings:

```javascript
    var gLocalizedStrings = new Map();

    var MozLoopServiceInternal = {
      // ...

      configureGLocalizedStringsWithKinto: function() {
        let FirefoxAdapter = Kinto.adapters.FirefoxAdapter;
        let config = {
           remote: "https://kinto-ota.dev.mozaws.net/v1",
           bucket: "loop-client",
           adapter: FirefoxAdapter
        };
        let db = new Kinto(config);
        let collectionName = "fr"; // XXX: this.locale getter can help
        let locales = db.collection(collectionName);
  
        return locales.db.open()
          .then(() => {
            return locales.sync();
          })
          .then(() => {
            return locales.list();
          })
          .then((res) => {
            res.data.forEach((record) => {
              gLocalizedStrings.set(record.key, record.value);
            });
          })
          .then(() => {
            return locales.db.close();
          });
        },

        initialize: Task.async(function*() {
          // ...

          // Start l10n initilization
          yield this.configureGLocalizedStringsWithKinto();

          // ...
        },
      // ...
    }
```

## Demo

{% video https://kinto-ota.dev.mozaws.net/attachments/demo.mp4 900 550 %}


# Conclusion

One of our objectives with this experiment was to illustrate what can
be done with Kinto within Firefox.

We have seen that using the embedded Kinto.js in Firefox is very
simple, and playful.

Relying on JSON schema to validate the records on the server also
proved useful for generating web forms in Kinto-admin. A Web UI really
helps to interact with the data, and the current product is only first
step!

With this article, we hope that our readers find inspiration and
imagine totally different use-cases!


# Going further?

The localization was a proof-of-concept that looks promising.

If it would have to be done seriously and ship in production, there
are still a number of blockers that should be investigated with the
help of the localization team.


## XUL and DTD Entities file loaded from Kinto

This experiment is based on the Firefox Hello component which is using
a properties file with the translations for each different view.

Other components are using properties files but some of them are also
using DTD Entity files for translation.

We would need to investigate how we can load the Entities file
dynamically.


## Tooling / Workflow

If we were to use Kinto we would need to integrate in the existing
translation flow.

This means letting [Elmo release managers](https://l10n.mozilla.org/) to ship
translation in the right Kinto collection for instance.


## l10n vs l20n: Asynchroneous translation loading

Today it seems that the translation loading is synchroneous into Firefox.

It could be interesting to migrate from l10n.js to l20n.js to load
translation asynchroneously.

This will remove the need to build a string maps at each view loading.

We could use the Firefox OS Music App to investigate how we could use
Kinto to translate strings asynchronously.


## Loading strings bundles in C++

Parts of Firefox are loading translation in C++, we would probably
need some helpers to load the Kinto SQLite translation database in
C++.


## Investigate the best way to sync translation

For the proof-of-concept we are sync-ing
[each key as a kinto record](https://kinto-ota.dev.mozaws.net/v1/buckets/loop-client/collections/fr/records>).

In order to ease the migration, it could be actually better to sync a
property file per kinto record.

Then we could change the createBundle function to actually load the
up-to-date file version from SQLite3.


## Ultimate goal strategy

Let's dream a bit and imagine what would be ideal for users, and
translators.

One ultimate goal could be to have a multi-language installer that
will let users select their language and then install the same Firefox
build with the right language configured by downloading the last
translation strings release.
