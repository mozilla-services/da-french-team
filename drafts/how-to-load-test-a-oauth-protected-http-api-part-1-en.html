<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Service de nuages, ">

        <link rel="alternate"  href="https://mozilla-services.github.io/servicedenuages.fr/feeds/all.atom.xml" type="application/atom+xml" title="Service de nuages Full Atom Feed"/>

        <title>How to load test a OAuth-protected HTTP API? (Part 1) // Service de nuages // </title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://mozilla-services.github.io/servicedenuages.fr/theme/css/pure.css">
    <link rel="stylesheet" href="https://mozilla-services.github.io/servicedenuages.fr/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <h5>Published</h5>
                <p title="~730 words">~3 minutes reading ðŸ•‘</p>
                <p>Wed, 02 December 2015</p>
                <a href="/en/">&larr; Back to articles</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>How to load test a OAuth-protected HTTP API? (Part 1)</h1>
                </header>
            </section>
            <p>This is part 1 of a series on loadtesting oauth APIs.</p>
<div class="section" id="what-is-oauth-and-how-do-you-use-it-to-authenticate-an-http-api">
<h2>What is OAuth and how do you use it to authenticate an HTTP API?</h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/OAuth">OAuth</a> is a protocol that
allows a user delegate some of its permissions to a web service
through an identity provider.</p>
<p>The user can be confident that the web service will never have their
user credentials (ID, password), instead it will get a Bearer Token
that is valid for a list of scopes and for a certain amount of time.</p>
<p>In the app, the user click on a Sign-In button that will redirect it
to the Identity Provider login page with the list of scopes the app
needs.</p>
<p>The user will enter her login credentials and validate the permission
list, once the credentials are correct, the Identity provider will
redirect the user to the app with the
<a class="reference external" href="http://tools.ietf.org/html/rfc6750">Bearer tokens</a> enclosed in the query string.</p>
<img alt="OAuth 2.0 Bearer Token creation flow" src="https://mozilla-services.github.io/servicedenuages.fr/images/oauth2-flow.png" style="width: 654px; height: auto; max-width: 100%;width: 654px; height: auto; max-width: 100%;"/>
<p>This Bearer Token will then be used by the app in the HTTP request
Authorization header to authenticate on the web service.</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/v1/articles</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Bearer e7613cae7a0660dae7a2dd55c216cbaef75f43254e2a8c77f7e9c7adb549bb65</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">readinglist.services.mozilla.com</span>
</pre></div>
</div>
<div class="section" id="why-would-you-need-to-run-a-load-test">
<h2>Why would you need to run a load test?</h2>
<p>After deploying an HTTP API you might be wondering how many users or
requests your deployment can take and what happens after it reaches
that number.</p>
<p>Knowing the maximum load your service can handle is a great thing to
know!  It tells you when to start scaling up when your production
server is close to reaching that number of requests per second.</p>
</div>
<div class="section" id="so-what-s-so-complicated-about-oauth">
<h2>So, what's so complicated about OAuth?</h2>
<p>Load testing a service that requires OAuth-based authentication means:</p>
<ul class="simple">
<li>having an OAuth account (often creating it)</li>
<li>getting a Bearer Token with the right scopes</li>
</ul>
<p>Doing all this setup, will add a number of requests. Plus it will take
time to wait for the email with the activation account link.</p>
<p>This can take a tremendous amount of time in the scope of a load test
which can slow down the all process and return inaccurate results.</p>
</div>
<div class="section" id="what-is-the-right-way-to-handle-this">
<h2>What is the right way to handle this?</h2>
<p>During a load test, make sure that your are only doing requests on the
service you are load testing.</p>
<p>If you are calling an identity provider or any other service during
the load test phases (either setup, tear down or scenario phase) your
load test performance will be impacted and will return inaccurate
results.</p>
<p>You should be able to write your load test with simple cURL commands
toward your service.</p>
</div>
<div class="section" id="configuration-over-code">
<h2>Configuration over code</h2>
<p>If your service needs Bearer tokens to be load tested, these Bearer
tokens should be provided to your load test code and not be generated
during the load test.</p>
<p>This can be done by configuration, either within a file or with
environment variables.</p>
</div>
<div class="section" id="some-code-to-configure-your-load-test">
<h2>Some code to configure your load test</h2>
<p>With regards to the kind of environment you want to run your load test
on (dev, stage, production), you may want to configure your load test
differently.</p>
<p>For instance, you may want to create a specific account or use an
existing one.</p>
</div>
<div class="section" id="working-with-environment-variables">
<h2>Working with environment variables</h2>
<p>It can be difficult to configure your load test code before running
it.</p>
<p>One way to do it is to define environment variables that will be set
before and that will be read by your code.</p>
<p>In order to define the environment variables you can write a Bash file
that you will be able to source before running your load test and that
will export all the needed environment variables.</p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OAUTH_BEARER_TOKEN</span><span class="o">=</span><span class="s2">"dd7e6b6d0f4d44d0df5d6b73afdfbad41c48c4abdaba50e428ce070f9d4c75b5"</span>
</pre></div>
<p>There are also utilities that might help you there, for instance,
<a class="reference external" href="https://docs.docker.com/engine/reference/run/#env-environment-variables">docker</a>
might set them for you.</p>
<div class="highlight"><pre><span></span>docker run -e <span class="nv">OAUTH_BEARER_TOKEN</span><span class="o">=</span><span class="s2">"abc..."</span> loadtest
</pre></div>
</div>
<div class="section" id="working-with-multiple-bearer-tokens">
<h2>Working with multiple Bearer Tokens</h2>
<p>If you need to use multiple users, you can add other environment
variables.</p>
<p>You can also set multiple users Bearer tokens using a comma-separated
list in the env variable and then split on it to choose one randomly
in your load test:</p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OAUTH_BEARER_TOKEN</span><span class="o">=</span><span class="s2">"</span>
<span class="s2">    dd7e6b6d0f4d44d0df5d6b73afdfbad41c48c4abdaba50e428ce070f9d4c75b5,</span>
<span class="s2">    b6af04a44aa0f5a6b3a3affbaa41c48c4abaaba50e428ce030f9a4cb356aa36e,</span>
<span class="s2">    a44aa0f5a6b3a3affbaa41c1c48c4abaaba50e428ce030f9428ce070f9d4c75b</span>
<span class="s2">    "</span>
</pre></div>
<p>Or you also could create multiple environment variables:</p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OAUTH_BEARER_TOKEN_SCOPE_PROFILE</span><span class="o">=</span><span class="s2">"dd7e6b6d0f4d44d0df5d6b73afdfbad41c48c4abdaba50e428ce070f9d4c75b5"</span>
<span class="nb">export</span> <span class="nv">OAUTH_BEARER_TOKEN_SCOPE_KINTO</span><span class="o">=</span><span class="s2">"</span>
<span class="s2">    b6af04a44aa0f5a6b3a3affbaa41c48c4abaaba50e428ce030f9a4cb356aa36e,</span>
<span class="s2">    a44aa0f5a6b3a3affbaa41c1c48c4abaaba50e428ce030f9428ce070f9d4c75b</span>
<span class="s2">    "</span>
</pre></div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>I hope that after reading this article, you are not afraid anymore of
load testing OAuth-based services!</p>
<p>Take-aways:</p>
<ul class="simple">
<li>You do not create the OAuth Bearer Token in your load test code.</li>
<li>You can use configuration and for instance environment variables to
configure your load test Bearer Token.</li>
</ul>
<p><a class="reference external" href="/en/load-testing-a-http-api-which-uses-oauth-for-authentication-part-2">The next article</a>
will show some specific tools you can use to do this.</p>
</div>

            <div class="hr"></div>
            <a href="#" class="go-top">Revenir au dÃ©but</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "servicedenuages"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div><footer class="footer">
    <p>&copy; Service de nuages &ndash;
        DÃ©veloppÃ© avec <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        et <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.notmyidea.org/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//piwik.notmyidea.org/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->
  <script src="https://mozilla-services.github.io/servicedenuages.fr/theme/js/instantclick.min.js" data-no-instant></script>
  <script data-no-instant>InstantClick.init();</script>
</body>
</html>