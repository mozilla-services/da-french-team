<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Service de nuages, ">

        <link rel="alternate"  href="https://mozilla-services.github.io/servicedenuages.fr/feeds/all.atom.xml" type="application/atom+xml" title="Service de nuages Full Atom Feed"/>

        <title>Workflow de validation dans Kinto // Service de nuages // </title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://mozilla-services.github.io/servicedenuages.fr/theme/css/pure.css">
    <link rel="stylesheet" href="https://mozilla-services.github.io/servicedenuages.fr/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <h5>Publi√©</h5>
                <p title="~927 mots">~4mn de lecture üïë</p>
                <p>lun. 14 novembre 2016</p>
                <a href="/">&larr; Liste des articles</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Workflow de validation dans Kinto</h1>
                        <p class="post-meta">                                <a class="post-category" href="https://mozilla-services.github.io/servicedenuages.fr/tag/mozilla.html">mozilla</a>
                        </p>
                </header>
            </section>
            <div class="section" id="le-besoin-initial">
<h2>Le besoin initial</h2>
<p>Une grosse partie de notre travail sur <em>Kinto</em> chez Mozilla consiste √† am√©liorer
l'acheminement de donn√©es de configuration dans Firefox. En particulier r√©duire
le temps de mise √† disposition et l'efficacit√© de leur mise √† jour.</p>
<p>Par exemple, lorsque ces donn√©es √©taient de simples fichiers JSON dans le d√©p√¥t Mercurial, leurs
modifications passaient par le processus de revue de code classique et leur livraison
via la prochaine release.</p>
<p>Acc√©lerer et fluidifier c'est super, mais il faut pas se louper !</p>
<p>Nous avions besoin d'un garde-fou qui permette de retrouver au moins autant de
s√©curit√© que le pr√©c√©dent syst√®me.</p>
<img alt="CC-BY-SA Kurt Bauschardt" class="align-center" src="https://mozilla-services.github.io/servicedenuages.fr/images/unsafe-conditions.jpg" style="width: 100%;width: 1600px; height: auto; max-width: 100%;"/>
<div class="section" id="le-besoin-universel">
<h3>Le besoin universel</h3>
<p>N'allez pas imaginer que ce besoin est sp√©cifique √† notre utilisation ou aux enjeux
li√©s √† la livraison de plusieurs centaines de millions de clients !</p>
<p>Prenez le cas d'une application qui consommerait des donn√©es controll√©es
par un administrateur (par exemple les valeurs propos√©es dans un formulaires, les
niveaux d'un jeu, les cha√Ænes traduites, les param√®tres positionn√©s par d√©faut etc.).</p>
<p>On veut pouvoir se prot√©ger des modifications h√¢tives ou maladroites du vendredi soir
ou des typos du lundi matin !</p>
<p>On veut aussi pouvoir v√©rifier que l'application fonctionne avec les nouvelles
donn√©es avant d'appliquer le changement √† tous.</p>
<p>Cela permet aussi d'envisager les cas d'utilisation o√π les donn√©es sont modifiables
par des contributeurs externes et valid√©es par quelqu'un de confiance !</p>
<img alt="CC-NC-ND WorldFish" class="align-center" src="https://mozilla-services.github.io/servicedenuages.fr/images/approve-shipment.jpg" style="width: 100%;width: 2048px; height: auto; max-width: 100%;"/>
</div>
</div>
<div class="section" id="la-solution">
<h2>La solution</h2>
<p>Nous avons impl√©ment√© un plugin qui se charge d'ajouter la fonctionnalit√© en utilisant
l'API de Kinto existante.</p>
<p>La fa√ßon la plus simple a consist√© √† utiliser plusieurs collections. La premi√®re
subit les changements, la suivante est mise √† jour lors de la demande de revue
et la derni√®re est mise √† jour si les changements sont approuv√©s.</p>
<div class="section" id="statut">
<h3>Statut</h3>
<p>Nous utilisons un attribut particulier (<tt class="docutils literal">status</tt>) sur l'object collection,
qui va servir √† demander la revue, approuver ou rejeter les changements.</p>
<ul class="simple">
<li>Lorsqu'un changement a lieu sur les enregistrements de la collection, le statut
passe √† <tt class="docutils literal"><span class="pre">work-in-progress</span></tt>.</li>
<li>En passant le statut √† <tt class="docutils literal"><span class="pre">to-review</span></tt> on demande une revue des changements
effectu√©s depuis la derni√®re revue approuv√©e.</li>
<li>En passant le statut √† <tt class="docutils literal"><span class="pre">to-sign</span></tt> on approuve les changements (<em>cf. prochaines
√©tapes pour le rapport avec les signatures</em>)</li>
</ul>
</div>
<div class="section" id="groupes">
<h3>Groupes</h3>
<p>La notion de groupes d'utilisateurs nous servait d√©j√† pour restreindre les
utilisateurs autoris√©s √† modifier les donn√©es. Pour les workflow de validation,
nous nous en servirons pour restreindre les utilisateurs autoris√©s √† demander
des revues de changements ou √† les valider.</p>
<p>√âvidemment, le syst√®me refuse que la personne qui a effectu√© les changements soit la
m√™me que celle qui les approuve.</p>
</div>
<div class="section" id="plugin-history">
<h3>Plugin History</h3>
<p>De base, <em>Kinto</em> ne conserve aucun historique. Lorsqu'un enregistrement est modifi√©
on ne conserve que la nouvelle version. De m√™me lors d'une suppression, un enregistrement
vide (aka. <em>tombstone</em>) remplace celui qui √©t√© supprim√©.</p>
<p>Pour permettre la revue des changements effectu√©s depuis la derni√®re validation,
nous avons <a class="reference external" href="https://kinto.readthedocs.io/en/latest/api/1.x/history.html">impl√©ment√© un plugin</a>
qui alimente un journal √† chaque op√©ration d'√©criture.</p>
<p>De cette mani√®re, il est possible de consulter l'extrait du journal sur la p√©riode
d√©finie par les deux <em>timestamps</em> ‚Äî celui de la <em>derni√®re validation</em> et celui
de la <em>demande de revue</em>.</p>
<p>Une entr√©e du journal contient¬†‚Äî entre autres ‚Äî les attributs suivants:</p>
<ul class="simple">
<li><tt class="docutils literal">action</tt>: cr√©ation, mise √† jour, suppression</li>
<li><tt class="docutils literal">user_id</tt>: qui ?</li>
<li><tt class="docutils literal">date</tt>: quand ?</li>
<li><tt class="docutils literal">target</tt>: quoi ?</li>
</ul>
<p>La cible contient l'objet soit cr√©√©, soit tel qu'il est √©tait avant
la modification ou la suppression. En d'autres termes, une entr√©e du journal
ne stocke pas de <em>diff</em> mais l'objet complet. Pour obtenir le diff d'une mise √†
jour il faudra comparer avec l'entr√©e pr√©c√©dente.</p>
</div>
<div class="section" id="http-api">
<h3>HTTP API</h3>
<p>Comme nous nous sommes repos√©s sur l'API HTTP existante, nous pouvons utiliser
le client Python de base pour demander ou approuver une revue de changements.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">kinto_http</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="n">editor_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">server_url</span><span class="o">=</span><span class="s2">"https://kinto.dev.mozaws.net/v1"</span><span class="p">,</span>
                       <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s2">"token"</span><span class="p">,</span> <span class="s2">"editor"</span><span class="p">),</span>
                       <span class="n">bucket</span><span class="o">=</span><span class="s2">"blog"</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"to-review"</span><span class="p">}</span>
<span class="n">editor_client</span><span class="o">.</span><span class="n">patch_collection</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="s2">"test"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</pre></div>
<p>En revanche pour l'historique, nous utilisons un nouveau endpoint: <tt class="docutils literal">GET <span class="pre">/buckets/{bid}/history</span></tt>.
Le client JS a une m√©thode li√©e au bucket:</p>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">KintoClient</span> <span class="nx">from</span> <span class="s2">"kinto-http"</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">KintoClient</span><span class="p">(</span><span class="s2">"https://kinto.dev.mozaws.net/v1"</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">Authorization</span><span class="o">:</span> <span class="s2">"Basic "</span> <span class="o">+</span> <span class="nx">btoa</span><span class="p">(</span><span class="s2">"token:test"</span><span class="p">)</span>
  <span class="p">}});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">bucket</span><span class="p">(</span><span class="s2">"blog"</span><span class="p">).</span><span class="nx">listHistory</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(({</span><span class="nx">data</span><span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">r</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">user_id</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">action</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">resource_name</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
  <span class="p">});</span>
</pre></div>
<pre class="literal-block">
ldap:leplatrem, create, collection, test
ldap:leplatrem, create, record, 37368867-9563-451e-9523-fb53e3d6da1e
ldap:leplatrem, update, record, 37368867-9563-451e-9523-fb53e3d6da1e
ldap:leplatrem, delete, record, 37368867-9563-451e-9523-fb53e3d6da1e
</pre>
</div>
</div>
<div class="section" id="web-admin">
<h2>Web Admin</h2>
<p>Pour pouvoir exploiter ces fonctionnalit√©s tranquillement, nous avons impl√©ment√©
un certain nombre d'am√©liorations dans la <a class="reference external" href="https://github.com/Kinto/kinto-admin">Kinto Admin</a>.</p>
<div class="section" id="id1">
<h3>Groupes</h3>
<p>Pour faciliter la gestion des utilisateurs autoris√©s √† apporter et approuver des
changements sur les donn√©es, nous avons impl√©ment√© la gestion des groupes, au
niveau des buckets et des permissions.</p>
<img alt="Group members management" class="align-center" src="https://mozilla-services.github.io/servicedenuages.fr/images/kinto-admin-edit-group.png" style="width: 2048px; height: auto; max-width: 100%;"/>
<img alt="Groups in permissions" class="align-center" src="https://mozilla-services.github.io/servicedenuages.fr/images/kinto-admin-edit-permissions.png" style="width: 1024px; height: auto; max-width: 100%;"/>
</div>
<div class="section" id="historique">
<h3>Historique</h3>
<p>Si le serveur a la fonctionnalit√© d'historique activ√©e, l'interface pr√©sentera
un onglet <em>Historique</em> sur chaque objet.</p>
<img alt="History of objects" class="align-center" src="https://mozilla-services.github.io/servicedenuages.fr/images/kinto-admin-history.png" style="width: 1024px; height: auto; max-width: 100%;"/>
</div>
<div class="section" id="worflows">
<h3>Worflows</h3>
<p>Comme les workflows de validation sont activ√©s via un plugin externe, nous avons
d√©cid√© d'en faire aussi un plugin pour l'admin. Cela nous a permis d'exp√©rimenter
le principe si l'on souhaite qu'il soit possible un jour de personnaliser facilement
l'interface pour des besoins sp√©cifiques.</p>
<p>Avec ce plugin, lorsqu'une collection est configur√©e pour √™tre revue et valid√©e,
un <em>widget</em> appara√Æt en haut de la liste des enregistrements.</p>
<img alt="Worflow UI" class="align-center" src="https://mozilla-services.github.io/servicedenuages.fr/images/kinto-admin-workflow.png" style="width: 1024px; height: auto; max-width: 100%;"/>
<p>Un lien permet d'acc√©der √† l'historique filtr√© avec les changements √† valider.
La collection interm√©diaire est √©galement accessible pour voir le r√©sultat
final ou tester dans un v√©ritable client en faisant pointer la collection dessus.</p>
</div>
</div>
<div class="section" id="prochaines-etapes">
<h2>Prochaines √©tapes</h2>
<p>Nous sommes sur le point de d√©ployer tout √ßa en production, et voici ce que nous
pr√©voyons pour la suite:</p>
<ul class="simple">
<li>Ajouter une √©tape dans le workflow pour dissocier l'approbation des changements
et la publication</li>
<li>Envoyer un email aux membres du groupe de <em>reviewers</em> lorsqu'un √©diteur demande
une revue.</li>
</ul>
<p>Les workflows ont √©t√© impl√©ment√©s en que fonctionnalit√©s du <a class="reference external" href="https://github.com/Kinto/kinto-signer/">plugin de signatures</a>,
qui ajoutait d√©j√† certaines garanties pour l'acheminement des donn√©es. Mais il est
possible que nous en fassions un plugin sp√©cifique dissoci√© de la signature...</p>
</div>

            <div class="hr"></div>
            <a href="#" class="go-top">Revenir au d√©but</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "servicedenuages"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div><footer class="footer">
    <p>&copy; Service de nuages &ndash;
        D√©velopp√© avec <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        et <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.notmyidea.org/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//piwik.notmyidea.org/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->
  <script src="https://mozilla-services.github.io/servicedenuages.fr/theme/js/instantclick.min.js" data-no-instant></script>
  <script data-no-instant>InstantClick.init();</script>
</body>
</html>